<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-slider/paper-slider.html">
<link rel="import" href="../paper-button/paper-button.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <seed-element></seed-element>

Example:

    <seed-element>
      <h2>Hello seed-element</h2>
    </seed-element>

@demo demo/index.html
@hero hero.svg
    <script src="//d3js.org/d3.v3.min.js"></script>
-->

<script src="../d3/d3.min.js"></script>
<script src="../download-as-file/dist/download-as-file.js"></script>

<dom-module id="sweva-visualization-line-graph">
    <template>
        <style>
            :host {
                display: block;
                box-sizing: border-box;
                font-family: 'Verdana', sans-serif;
                background-color: white;
            }

            .hidden {
                display: none;
            }

            .menu {
                padding: 8px;
            }

            .horizontal-flex {
                display: flex;
                flex-direction: row;
                position: relative;
                align-items: center;
            }

            .label {
                font-size: small;
            }

            paper-button {
                color: #fff;
                background: #ABABAB;
            }
            
        </style>

        <div id="canvas">
        </div>
        <div class="horizontal-flex">
            <div class="menu">
                <paper-dropdown-menu label="Export as..." vertical-align="bottom">
                    <paper-menu class="dropdown-content">
                        <paper-item on-click="getSvg">SVG</paper-item>
                        <paper-item on-click="getPng">PNG</paper-item>
                    </paper-menu>
                </paper-dropdown-menu>
            </div>
            <div>
                <span class="label">Zoom</span><paper-slider id="zoom-slider" pin></paper-slider>
            </div>
            <paper-button id="reset-zoom" raised on-click="resetZoom">
                Reset
            </paper-button>
        </div>
        <img id="hiddenImage" class="hidden" />
        <canvas id="hiddenCanvas" class="hidden"></canvas>
        <a id="hiddenLink" class="hidden"></a>
    </template>
    <script>
        Polymer({
            is: 'sweva-visualization-line-graph',

            properties: {
                config: {
                    type: Object,
                    value: null
                },
                dimensions: {
                    type: Object,
                    value: {
                        width: 1000,
                        height: 500
                    }
                },
                focuses: {
                    type: Array,
                    value: []
                },
                data: {
                    type: Object,
                    value: [],
                    observer: 'dataChanged'
                },
                config: {
                    type: Object,
                    value: {},
                    observer: 'configChanged'
                }

            },

            dataChanged: function () {

                if (this.data.length == 0) {
                    return;
                }
                if (!this.initialized) {
                    this.clear();
                    this.setup(this.config);
                }
                this.update();
            },

            configChanged: function () {
                if (Object.keys(this.config).length > 0) {
                    this.clear();
                    this.setup(this.config);
                }

            },
            // Element Lifecycle

            ready: function () {
                if (!this.initialized) {
                    this.clear();
                    this.setup(this.config);
                }

            },

            attached: function () {

            },

            detached: function () {
                // The analog to `attached`, `detached` fires when the element has been
                // removed from a document.
                //
                // Use this to clean up anything you did in `attached`.
            },

            // Element Behavior
            setup: function (config) {

                this.initialized = true;

                this.config.label = config.label || 'Graph';
                this.config.ylabel = config.ylabel || 'y';
                this.config.xlabel = config.xlabel || 'x';
                this.config.xtype = config.xtype || 'linear';
                this.config.ytype = config.ytype || 'linear';
                this.config.xparse = config.xparse || '';
                this.config.yparse = config.yparse || '';
                this.config.xprint = config.xprint || '';
                this.config.yprint = config.yprint || '';

                this.parseDate = [null, null];
                if (this.config.xtype == 'date') {
                    this.parseDate[0] = d3.time.format(this.config.xparse).parse;
                }
                if (this.config.ytype == 'date') {
                    this.parseDate[1] = d3.time.format(this.config.yparse).parse;
                }

                this.margin = { top: 50, right: 50, bottom: 150, left: 70 };
                this.width = this.dimensions.width - this.margin.left - this.margin.right;
                this.height = this.dimensions.height - this.margin.top - this.margin.bottom;

                this.svg = d3.select('#canvas').append('svg')
                   .attr('viewBox', '0 0 ' + (this.width + this.margin.left + this.margin.right) + ' ' + (this.height + this.margin.top + this.margin.bottom))
                   .attr('font', '15px sans-serif')
                 .append('g')
                   .attr('transform', 'translate(' + this.margin.left + ',' + this.margin.top + ')');

                this.svg.append('rect')
                    .attr('x', -this.margin.left)
                    .attr('y', -this.margin.top)
                    .attr('width', this.dimensions.width)
                    .attr('height', this.dimensions.height)
                    .attr('fill', '#fff');

                this.rect = this.svg.append('rect')
                   .attr('id', 'clientRect')
                   .attr('width', this.width)
                   .attr('height', this.height)
                   .attr('fill', '#fff')
                   .on('mousemove', this.mousemove.bind(this));

                this.svg.append('clipPath')
                  .attr('id', 'clip-lines')
                  .append('rect')
                  .attr('x', 0)
                  .attr('y', 0)
                  .attr('width', this.width)
                  .attr('height', this.height);

                this.svg.append('text')
                    .attr('class', 'y label')
                    .attr('text-anchor', 'end')
                    .attr('x', this.width - 6)
                    .attr('y', this.height - 6)
                    .text(this.config.xlabel);

                this.svg.append('text')
                    .attr('class', 'y label')
                    .attr('text-anchor', 'end')
                    .attr('y', 6)
                    .attr('x', -6)
                    .attr('dy', '.75em')
                    .attr('transform', 'rotate(-90)')
                    .text(this.config.ylabel);

                this.svg.append('text')
                    .attr('class', 'title label')
                    .attr('text-anchor', 'middle')
                    .attr('x', this.width / 2)
                    .attr('y', -15)
                    .attr('font-size', 20)
                    .attr('font-weight', 600)
                    .text(this.config.label);

                this.getX = (function (d) {
                    return this.x(d[0])
                }).bind(this);

                this.getY = (function (d) {
                    return this.y(d[1])
                }).bind(this);

                this.svg.append('g')
                  .attr('class', 'x axis');

                this.svg.append('g')
                   .attr('class', 'y axis');

            },

            update: function (data) {
                if (typeof data != 'undefined') {
                    this.data = data;
                    return;
                }
                var xMin = 0;
                var xMax = 0;
                var yMin = 0;
                var yMax = 0;
                
                for (var i = 0; i < this.data.length; i++) {
                    

                    if (this.config.xtype == 'date') {

                        if (this.data[i].data.length > 0 && typeof this.data[i].data[0][0]==='string') {
                            for (var k = 0; k < this.data[i].data.length; k++) {
                                this.data[i].data[k][0] = this.parseDate[0](this.data[i].data[k][0]);
                            }
                        }
                    }
                    
                    if (this.data[i].data.length > 0 && typeof this.data[i].data[0][1] === 'string') {
                        if (this.config.ytype == 'date') {
                            for (var k = 0; k < dataSetthis.data[i].data.length; k++) {
                                this.data[i].data[k][1] = this.parseDate[1](this.data[i].data[k][1]);
                            }
                        }
                    }
                }
                
                //global min max
                for (var i = 0; i < this.data.length; i++) {

                    if (this.config.xtype == 'linear') {
                        var xmin = d3.min(this.data[i].data, function (d) {
                            return d[0];
                        });
                        var xmax = d3.max(this.data[i].data, function (d) {
                            return d[0];
                        });

                        if (xmin < xMin) {
                            xMin = xmin;
                        }
                        if (xmax > xMax) {
                            xMax = xmax;
                        }
                    }

                    if (this.config.ytype == 'linear') {
                        var ymin = d3.min(this.data[i].data, function (d) {
                            return d[1];
                        });
                        var ymax = d3.max(this.data[i].data, function (d) {
                            return d[1];
                        });
                        if (ymin < yMin) {
                            yMin = ymin;
                        }
                        if (ymax > yMax) {
                            yMax = ymax;
                        }

                    }

                }

                if (this.config.xtype == 'date') {
                    xMin = (this.data[0].data[0][0]);
                    xMax = (this.data[0].data[this.data[0].data.length - 1][0]);
                    this.x = d3.time.scale()
                        .domain([xMin, xMax])
                        .range([0, this.width]);
                }
                else if (this.config.xtype == 'linear') {
                    this.x = d3.scale.linear()
                        .domain([xMin, xMax])
                        .range([0, this.width]);
                }

                if (this.config.ytype == 'date') {
                    yMin = (this.data[0].data[0][1]);
                    yMax = (this.data[0].data[this.data[0].data.length - 1][1]);
                    this.y = d3.time.scale()
                        .domain([yMin, yMax])
                        .range([this.height, 0]);
                }
                else if (this.config.ytype == 'linear') {
                    this.y = d3.scale.linear()
                       .domain([yMin, yMax])
                       .range([this.height, 0]);
                }

                this.xAxis = d3.svg.axis()
                    .scale(this.x)
                    .orient('bottom')
                    .ticks(10 * Math.floor(this.width / this.height))
                    .tickSize(-this.height);

                if (this.config.xtype == 'date') {
                    this.xAxis = this.xAxis.tickFormat(d3.time.format(this.config.xprint));
                }

                this.yAxis = d3.svg.axis()
                    .scale(this.y)
                    .orient('left')
                    .ticks(10)
                    .tickSize(-this.width);

                if (this.config.ytype == 'date') {
                    this.yAxis = this.yAxis.tickFormat(d3.time.format(this.config.yprint));
                }
                this.zoom = d3.behavior.zoom()
                    .x(this.x)
                    .y(this.y)
                    .scaleExtent([1, 10])
                    .on('zoom', this.zoomed.bind(this));

                var slider = d3.select('#zoom-slider')
                  .attr("value", this.zoom.scaleExtent()[0])
                  .attr("min", this.zoom.scaleExtent()[0])
                  .attr("max", this.zoom.scaleExtent()[1])
                  .attr("step", ((this.zoom.scaleExtent()[1] - this.zoom.scaleExtent()[0]) / 100).toFixed(1))
                  .on("immediate-value-change", this.slided.bind(this));

                this.svg.select('.x.axis')
                    .attr('transform', 'translate(0,' + this.height + ')')
                    .call(this.xAxis)

                    .selectAll('text')
                        .style('text-anchor', 'end')
                        .attr('dx', '-.8em')
                        .attr('dy', '.15em')
                        .attr('transform', 'rotate(-65)');

                this.svg.select('.y.axis')
                    .call(this.yAxis);

                this.svg.selectAll('.axis path, .axis line')
                        .attr('fill', 'none')
                        .attr('stroke', '#7a95ac')
                        .attr('shape-rendering', 'optimizeSpeed');

                this.svg.call(this.zoom);

                this.focuses = [];
                this.lineGen = d3.svg.line()
                  .x(this.getX)
                  .y(this.getY);

                var colors = [
                    '#1D00B5',
                    '#BA2E00',
                    '#8B00BA',
                    '#078700',
                    '#003487',
                    '#000000',
                    '#006942',
                    '#690027',
                    '#9E494A'

                ];

                this.svg.selectAll('.data-representation').remove();
                for (var i = 0; i < this.data.length; i++) {

                    if (this.data[i].type == 'dots') {
                        var x = this.x;
                        var y = this.y;
                        this.svg.selectAll('.dot' + i)
                            .data(this.data[i].data)
                            .enter()
                           .append('circle')
                           .attr('class', 'data-representation dot' + i)
                           .attr("r", 3)
                           .attr("cx", this.getX)
                           .attr("cy", this.getY)
                           .attr('clip-path', 'url(#clip-lines)')
                           .attr('stroke', 'none')

                           .attr('fill', this.data[i].color || colors[i]);
                    }
                    else {
                        this.svg
                           .append('path')
                           .attr('class', 'data-representation line' + i)
                           .attr('d', this.lineGen(this.data[i].data))
                           .attr('clip-path', 'url(#clip-lines)')
                           .attr('stroke', this.data[i].color || colors[i])
                           .attr('stroke-width', 2)
                           .attr('fill', 'none');
                    }

                }

                var xSpace = this.width / 3;
                var xIndex = 0;
                var yIndex = 0;
                for (var i = 0; i < this.data.length; i++) {
                    yindex = i % 3;
                    xIndex = Math.floor(i / 3);
                    this.svg.select('.legend-rect' + i).remove();
                    this.svg.append('rect')
                        .attr('class', 'legend-rect' + i)
                        .attr('x', xIndex * xSpace)
                        .attr('y', this.height + this.margin.bottom - 28 - 30 + yindex * 20)
                        .attr('width', 15)
                        .attr('height', 15)
                        .style('fill', this.data[i].color || colors[i])

                    this.svg.select('.legend-text' + i).remove();
                    this.svg.append('text')
                        .attr('class', 'legend-text' + i)
                        .attr('x', xIndex * xSpace + 20)
                        .attr('y', this.height + this.margin.bottom - 15 - 30 + yindex * 20)
                        .style('fill', 'black')
                        .text(this.data[i].label);
                }

                this.svg.selectAll('.focus').remove();
                for (var i = 0; i < this.data.length; i++) {

                    var focus = this.svg.append('g')
                        .attr('class', 'focus')
                        .style('display', '')
                        .style('pointer-events','none')

                    focus.append('circle')
                        .attr('r', 4.5)
                        .attr('fill', 'none')
                        .attr('stroke', '#00475E')

                    focus.append('text')
                        .attr('class', 'text-bx' + i)
                        .attr('x', 9)
                        .attr('y', 19)
                        .attr('fill', 'black')
                        .attr('stroke', 'white')
                        .attr('stroke-width', 3)
                        .attr('dy', '.35em')
                    focus.append('text')
                        .attr('class', 'text-x' + i)
                        .attr('x', 9)
                        .attr('y', 19)
                        .attr('dy', '.35em')

                    focus.append('text')
                       .attr('class', 'text-by' + i)
                       .attr('x', 9)
                       .attr('dy', '.35em')
                       .attr('fill', 'black')
                       .attr('stroke', 'white')
                       .attr('stroke-width', 3)

                    focus.append('text')
                        .attr('class', 'text-y' + i)
                        .attr('x', 9)
                        .attr('dy', '.35em');

                    this.focuses.push(focus);
                }

            },
            clear: function () {
                
                var children = Polymer.dom(this.$.canvas).children;
                for (var i = 0; i < children.length; i++) {
                    Polymer.dom(this.$.canvas).removeChild(children[i]);
                }
                Polymer.dom.flush();
                
            },
            resetZoom: function () {
                this.zoom.translate([0, 0]).scale(this.zoom.scaleExtent()[0]).event(this.svg);
            },
            slided: function (event) {

                var center = [this.width / 2, this.height / 2];
                var translate = this.zoom.translate();
                var scale = this.zoom.scale();
                var targetZoom = event.immediateValue;
                var target = [(center[0] - translate[0]) / scale, (center[1] - translate[1]) / scale];

                translate[0] += center[0] - (target[0] * targetZoom + translate[0]);
                translate[1] += center[1] - (target[1] * targetZoom + translate[1]);
                this.zoom.translate(translate).scale(targetZoom).event(this.svg);

            },
            zoomed: function () {

                d3.select('#zoom-slider').property("value", d3.event.scale);

                var t = d3.event.translate,
                    s = d3.event.scale;

                t[0] = Math.max(t[0], this.width - this.width * s);
                t[0] = Math.min(t[0], 0);

                t[1] = Math.max(t[1], this.height - this.height * s);
                t[1] = Math.min(t[1], 0);

                this.zoom.translate(t);

                for (var i = 0; i < this.data.length; i++) {
                    this.svg.select('.line' + i).attr('d', this.lineGen(this.data[i].data));
                    this.svg.select('.dot' + i)
                        .attr("r", 10)
                        .attr("cx", this.getX)
                        .attr("cy", this.getY)

                    this.svg.selectAll('.dot' + i)
                            .data(this.data[i].data)
                            .attr("cx", this.getX)
                            .attr("cy", this.getY)
                }
                // .attr('transform', 'translate(' + d3.event.translate + ')scale(' + d3.event.scale + ')');
                this.svg.select('.x.axis').call(this.xAxis).selectAll('text')
                    .style('text-anchor', 'end')
                    .attr('dx', '-.8em')
                    .attr('dy', '.15em')
                    .attr('transform', 'rotate(-65)');
                this.svg.select('.y.axis').call(this.yAxis);

                this.svg.selectAll('.axis path, .axis line')
                        .attr('fill', 'none')
                        .attr('stroke', '#7a95ac')
                        .attr('shape-rendering', 'optimizeSpeed');

                for (var i = 0; i < this.focuses.length; i++) {
                    var focus = this.focuses[i];
                    focus.style('display', 'none');
                }

            },
            mousemove: function () {
                //console.log(d3.select('#clientRect'));
                var bisectDate = d3.bisector(function (d) { return d[0]; }).left;
                var posHash = {};
                for (var k = 0; k < this.focuses.length; k++) {
                    var focus = this.focuses[k];
                    var x0 = this.x.invert(d3.mouse(this.rect[0][0])[0]);
                    var i = bisectDate(this.data[k].data, x0, 1);
                    d0 = this.data[k].data[i - 1],
                    d1 = this.data[k].data[i];

                    var d = d0;

                    if (typeof d1 !== 'undefined') {
                        d = x0 - d0[0] > d1[0] - x0 ? d1 : d0;
                    }

                    var xPos = this.x(d[0]);
                    var yPos = this.y(d[1]);
                    if (yPos < 0 || yPos > this.height) {
                        focus.style('display', 'none');
                        return;
                    }

                    if (posHash.hasOwnProperty(xPos + ':' + yPos)) {
                        focus.style('display', 'none');
                    }
                    else {
                        posHash[xPos + ':' + yPos] = true;
                        focus.style('display', '');
                    }
                    //console.log(xPos, yPos);
                    focus.attr('transform', 'translate(' + xPos + ',' + yPos + ')');

                    var textX = d[0];
                    var textY = d[1];

                    if (this.config.xtype == 'date') {
                        textX = d3.time.format(this.config.xprint)(d[0]);
                    }
                    if (this.config.ytype == 'date') {
                        textY = d3.time.format(this.config.yprint)(d[1]);
                    }
                    focus.select('.text-x' + k).text(textX);
                    focus.select('.text-bx' + k).text(textX);
                    focus.select('.text-y' + k).text(textY);
                    focus.select('.text-by' + k).text(textY);
                }

            },
            convertSvg: function () {
                //http://stackoverflow.com/questions/23218174/how-do-i-save-export-an-svg-file-after-creating-an-svg-with-d3-js-ie-safari-an

                d3.selectAll('text')
                  .attr('font-family', 'Verdana');
                for (var i = 0; i < this.focuses.length; i++) {
                    var focus = this.focuses[i];
                    focus.style('display', 'none');
                }
                var svg = this.$.canvas.querySelector('svg');

                //get svg source.
                var serializer = new XMLSerializer();
                var source = serializer.serializeToString(svg);

                //add name spaces.
                if (!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)) {
                    source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
                }
                if (!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)) {
                    source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
                }

                //add xml declaration
                source = '<?xml version="1.0" standalone="no"?>' + source.replace(/\n/g, '');

                return source;
            },
            getSvg: function () {
                var source = this.convertSvg();

                downloadAsFile({
                    data: source,
                    filename: this.config.label + '.svg'
                });

            },
            getPng: function () {

                var source = this.convertSvg();
                var width = this.dimensions.width;
                var height = this.dimensions.height;
                var imgsrc = 'data:image/svg+xml;utf8,' + source;
                var img = this.$.hiddenImage;

                var canvas = this.$.hiddenCanvas;
                canvas.height = height;
                canvas.width = width;
                var context = canvas.getContext('2d');
                var title = this.config.label;
                var link = this.$.hiddenLink;

                img.onload = function () {
                    context.drawImage(img, 0, 0, width, height, 0, 0, width, height);
                    var canvasdata = canvas.toDataURL('image/png');

                    link.download = title + '.png';
                    link.href = canvasdata;
                    link.click();

                }
                img.width = width;
                img.height = height;
                img.src = imgsrc;

            }

        });
    </script>
</dom-module>